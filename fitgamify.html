<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FitGamify ‚Äì Builder + S√©ance (GitHub Import)</title>
<style>
  :root{
    --bg1:#0f1623; --bg2:#1b2433; --card:#121a28; --border:#273349;
    --txt:#e8efff; --muted:#9fb2d3; --glow1:#6a8bff; --glow2:#b26bff;
    --btn:#3157ff; --btn2:#263247; --good:#22c55e; --danger:#e53935;
  }
  *{box-sizing:border-box}
  body{
    margin:0; padding:18px; color:var(--txt);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    background:radial-gradient(1200px 600px at 10% -10%, #1f2a40 0%, transparent 60%),
               linear-gradient(135deg, var(--bg1), var(--bg2));
  }
  .wrap{max-width:980px; margin:0 auto; display:grid; gap:14px}
  header{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
  h1{
    margin:0; font-size:1.6rem;
    background:linear-gradient(90deg,var(--glow1),var(--glow2));
    -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  }
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .btn{
    background:var(--btn2); color:#e8efff; border:1px solid #3a4a67;
    padding:.55rem .8rem; border-radius:10px; cursor:pointer; font-weight:600; text-decoration:none;
  }
  .btn.primary{ background:var(--btn); border-color:var(--btn) }
  .btn.good{ background:var(--good); border-color:transparent; color:#0b2a13 }
  .btn.danger{ background:var(--danger); border-color:transparent }
  .btn:disabled{opacity:.6; cursor:default}
  .card{
    background:linear-gradient(180deg,#121a28,#0d1523);
    border:1px solid var(--border); border-radius:16px; padding:16px;
    box-shadow:0 10px 24px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.03);
  }
  h2{margin:.2rem 0 1rem; font-size:1.1rem}
  h3{margin:.2rem 0 .6rem; font-size:1rem; color:#cfe3ff}
  .muted{color:var(--muted)}
  select, input[type="number"], input[type="text"], textarea{
    background:#0f1725; color:var(--txt); border:1px solid #334155;
    padding:10px 12px; border-radius:10px; outline:none; width:100%;
  }
  .two{display:grid; gap:10px}
  @media(min-width:850px){ .two{grid-template-columns:1.2fr .8fr} }
  .exercise-entry{
    background:#0f1725; border:1px solid #243149; border-radius:12px;
    padding:10px; margin:8px 0;
  }
  .series-row{display:flex; flex-direction:column; gap:8px; margin:.3rem 0}
  @media(min-width:520px){ .series-row{flex-direction:row; align-items:center} }
  .timer{color:var(--muted); font-size:.9rem; margin-left:.4rem}
  #history{max-height:320px; overflow:auto; display:grid; gap:8px}
  .hist-item{display:flex; gap:10px; align-items:flex-start; background:#0f1725; border:1px solid #243149; border-radius:10px; padding:10px}
  .hist-item pre{margin:0; white-space:pre-wrap; color:#cfe3ff}
  .right{margin-left:auto; display:flex; gap:8px}
  .quote{color:var(--muted); font-style:italic; margin:.2rem 0 1rem}
  .pill{display:inline-flex; gap:8px; align-items:center; padding:6px 10px; background:#0f1725; border:1px solid #243149; border-radius:999px}
  .tag{background:#13203a; border:1px solid #243149; padding:2px 6px; border-radius:999px; font-size:.85rem; color:#cfe3ff}
  .list{display:grid; gap:8px; max-height:280px; overflow:auto}
  .list-item{display:flex; align-items:center; gap:8px; background:#0f1725; border:1px solid #243149; border-radius:10px; padding:8px}
  .list-item .name{flex:1}
  .ghost{opacity:.6}
  /* Modal image */
  .modal{position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:9999}
  .modal.open{display:flex}
  .modal-card{background:#0b1220; border:1px solid #29405f; border-radius:14px; padding:10px; max-width:92vw; max-height:92vh; display:grid; gap:8px}
  .modal-card img{max-width:90vw; max-height:80vh; border-radius:10px}
  .modal-head{display:flex; align-items:center; justify-content:space-between; gap:8px}
  /* Toast */
  #toast{position:fixed; left:50%; transform:translateX(-50%); bottom:16px; background:rgba(0,0,0,.85); color:#fff; padding:.6rem .9rem; border-radius:10px; opacity:0; pointer-events:none; transition:opacity .2s; z-index:9999}
  #toast.show{opacity:1}
  details summary{cursor:pointer; user-select:none; color:#cfe3ff}
</style>
</head>
<body>
<div class="wrap">

  <header>
    <h1>üèãÔ∏è FitGamify ‚Äì Builder & S√©ance</h1>
    <div class="row">
      <a class="btn" href="index.html">üè† Accueil</a>
      <button id="openStats" class="btn">üìä Statistiques</button>
    </div>
  </header>
  <p class="quote" id="quote">‚ÄúL‚Äôentra√Ænement ne ment jamais.‚Äù</p>

  <!-- BUILDER -->
  <div class="card">
    <h2>üß∞ Cr√©er / Modifier un programme</h2>
    <div class="two">
      <!-- Colonne gauche: d√©finition programme -->
      <div>
        <div class="row" style="gap:8px">
          <div style="flex:2">
            <div class="muted">Nom du programme</div>
            <input id="progName" placeholder="ex: Full Body Force"/>
          </div>
          <div style="flex:1">
            <div class="muted">Mode</div>
            <select id="progMode">
              <option value="series">S√©ries (finir les s√©ries exo par exo)</option>
              <option value="circuit">Circuit / Set (encha√Æner tous les exos, X tours)</option>
            </select>
          </div>
          <div style="flex:1" id="seriesCountWrap">
            <div class="muted">S√©ries/exo</div>
            <input id="seriesCount" type="number" min="1" max="10" value="3"/>
          </div>
          <div style="flex:1; display:none" id="roundsWrap">
            <div class="muted">Tours (circuit)</div>
            <input id="rounds" type="number" min="1" max="20" value="3"/>
          </div>
        </div>

        <div style="margin-top:10px">
          <div class="muted">Exercices du programme (ordre = ordre d‚Äôex√©cution)</div>
          <div id="programList" class="list"></div>
          <div class="row" style="margin-top:8px">
            <button class="btn good" id="saveProgramBtn">üíæ Enregistrer / √âcraser</button>
            <button class="btn" id="loadProgramBtn">üì• Charger</button>
            <button class="btn danger" id="clearProgramBtn">üßΩ Vider</button>
          </div>
        </div>

        <!-- IMPORT GITHUB -->
        <details style="margin-top:14px">
          <summary>üì• Importer les exercices depuis ton dossier <code>images/</code> (GitHub)</summary>
          <div class="exercise-entry" style="margin-top:8px">
            <div class="row">
              <input id="ghOwner" placeholder="owner (ex: tonPseudo)" style="flex:1"/>
              <input id="ghRepo"  placeholder="repo (ex: tonRepoPages)" style="flex:1"/>
            </div>
            <div class="row">
              <input id="ghBranch" value="main" placeholder="branche (main/gh-pages)" style="flex:1"/>
              <input id="ghPath"   value="images" placeholder="chemin (images)" style="flex:1"/>
            </div>
            <div class="row">
              <select id="ghDefaultType" style="flex:1">
                <option value="strength">Type par d√©faut: Force/Muscu</option>
                <option value="running">Type par d√©faut: Running</option>
              </select>
              <input id="ghNameTransform" placeholder="Remplacements nom (ex: _: , -: )" style="flex:2"/>
            </div>
            <div class="row">
              <button class="btn" id="ghScanBtn">üîé Scanner & synchroniser</button>
              <span class="muted">Ajoute/Met √† jour automatiquement les exercices (image = <code>path/nomFichier</code>).</span>
            </div>
            <div id="ghResult" class="muted" style="margin-top:6px"></div>
          </div>
        </details>
      </div>

      <!-- Colonne droite: catalogue exercice -->
      <div>
        <h3>üìö Catalogue d‚Äôexercices</h3>
        <div class="row">
          <input id="exoName" placeholder="Nom ex: Squat, Traction‚Ä¶"/>
        </div>
        <div class="row">
          <select id="exoType" style="flex:1">
            <option value="strength">Force/Muscu</option>
            <option value="running">Running</option>
          </select>
          <input id="exoImg" placeholder="URL image (optionnel)" style="flex:2"/>
        </div>

        <!-- Aper√ßu image -->
        <div id="imgPreviewWrap" class="muted" style="margin-top:6px; display:none;">
          <span>Aper√ßu :</span>
          <div style="margin-top:6px;">
            <img id="imgPreview" alt="aper√ßu exercice" style="max-width:180px; max-height:120px; border-radius:8px; border:1px solid #243149;">
          </div>
        </div>

        <div class="row" id="exoDefaultsStrength" style="margin-top:6px">
          <input id="exoHint" placeholder="Indices ex: 50/80/80 (kg)"/>
        </div>
        <div class="row" id="exoDefaultsRun" style="display:none; margin-top:6px">
          <input id="exoDist" type="number" step="0.1" placeholder="km par d√©faut"/>
          <input id="exoTime" type="number" step="1" placeholder="min par d√©faut"/>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="addExoToCatalog">‚ûï Ajouter au catalogue</button>
        </div>

        <div class="muted" style="margin-top:8px">Catalogue (clic ‚ûï pour l‚Äôajouter au programme)</div>
        <div id="catalogList" class="list"></div>
      </div>
    </div>
  </div>

  <!-- S√âANCE -->
  <div class="card">
    <h2>üéØ Lancer une s√©ance</h2>
    <div class="row">
      <select id="selectProgram"></select>
      <button class="btn primary" id="startSessionBtn">‚ñ∂ D√©marrer</button>
    </div>
  </div>

  <div class="card" id="sessionCard" style="display:none">
    <h2>üìÜ S√©ance en cours</h2>
    <div id="exercises"></div>

    <div class="exercise-entry" style="margin-top:10px">
      <b>‚ûï Exercice libre (optionnel)</b>
      <div id="freeList" class="list"></div>
      <div class="row" style="margin-top:6px">
        <button class="btn" onclick="addFreeLine()">Ajouter une ligne</button>
        <button class="btn danger" onclick="clearFree()">Effacer libres</button>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <button class="btn primary" onclick="saveSession()">üíæ Enregistrer la s√©ance</button>
    </div>
  </div>

  <!-- HISTORIQUE -->
  <div class="card">
    <h2>üìÇ Historique local</h2>
    <div id="history">Aucune s√©ance encore.</div>
  </div>

</div>

<!-- Modal image -->
<div id="imgModal" class="modal" onclick="closeModal(event)">
  <div class="modal-card">
    <div class="modal-head">
      <div id="imgTitle" class="muted">Illustration</div>
      <button class="btn danger" onclick="hideModal()">Fermer ‚úñ</button>
    </div>
    <img id="imgView" src="" alt="illustration"/>
  </div>
</div>

<div id="toast"></div>

<script>
/* ====== Constantes & cl√©s ====== */
const HISTORY_KEY = "fitHistory";
const PROGS_KEY   = "fitProgramsV3";
const CATALOG_KEY = "fitCatalogV1";
const LAST_KEY    = "fitLastInputs";

const quotes = [
  "‚ÄúCe qui te semble impossible aujourd‚Äôhui sera ton √©chauffement demain.‚Äù",
  "‚ÄúPousse-toi toi-m√™me, personne ne le fera √† ta place.‚Äù",
  "‚ÄúLa discipline, c‚Äôest choisir entre ce que tu veux maintenant et ce que tu veux vraiment.‚Äù",
  "‚ÄúVise le progr√®s, pas la perfection.‚Äù",
  "‚ÄúPas besoin d‚Äô√™tre extr√™me, juste r√©gulier.‚Äù",
  "‚ÄúLa sueur, c‚Äôest juste la graisse qui pleure.‚Äù",
  "‚ÄúLes excuses ne br√ªlent pas de calories.‚Äù",
  "‚ÄúUn combat se gagne d‚Äôabord dans la t√™te, ensuite sur le ring.‚Äù",
  "‚ÄúUn jour ou jour un : √† toi de choisir.‚Äù",
  "‚ÄúLa douleur est temporaire, l‚Äôabandon est √©ternel.‚Äù"
];

/* ====== √âtat ====== */
let programs = load(PROGS_KEY) || {};
let catalog  = load(CATALOG_KEY) || seedCatalog();
let lastVals = load(LAST_KEY) || {};
let freeLines = []; // exercices libres pendant s√©ance

/* ====== Helpers ====== */
const $ = id => document.getElementById(id);
function toast(msg){ const t=$('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200); }
function load(k){ try{ return JSON.parse(localStorage.getItem(k)||""); }catch{ return null; } }
function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function titleFromFilename(fn){
  // enl√®ve extension
  const base = fn.replace(/\.[a-z0-9]+$/i, "");
  // remplacements optionnels fournis (ex: "_: , -: ")
  const mapTxt = $('ghNameTransform')?.value || "";
  let name = base;
  mapTxt.split(",").forEach(pair=>{
    const [from,to] = pair.split(":").map(s=> (s||"").trim());
    if(from){ name = name.split(from).join(to||" "); }
  });
  // fallback: tirets/underscores -> espace, capitalisation mots
  name = name.replace(/[-_]+/g," ").trim();
  name = name.split(" ").map(w=> w.charAt(0).toUpperCase()+w.slice(1)).join(" ");
  return name;
}

/* ====== Seed catalogue minimal ====== */
function seedCatalog(){
  return [
    { name:"Squat machine press", type:"strength", img:"images/squat.png", hint:"50/80/80" },
    { name:"Deadlift", type:"strength", img:"images/deadlift.jpg", hint:"40/40/40" },
    { name:"Traction", type:"strength", img:"", hint:"PDC/PDC/PDC" },
    { name:"Course (Distance)", type:"running", img:"", dist:5, time:30 },
  ];
}

/* ====== UI init ====== */
function displayQuote(){
  $('quote').textContent = quotes[Math.floor(Math.random()*quotes.length)];
}
function refreshProgramSelects(){
  const sel = $('selectProgram');
  const keys = Object.keys(programs);
  sel.innerHTML = keys.length ? keys.map(k=>`<option value="${k}">${k}</option>`).join('') : '<option value="">(Aucun programme)</option>';
}
function renderCatalog(){
  const box = $('catalogList'); box.innerHTML = "";
  if(!catalog.length){ box.innerHTML = `<div class="muted">Catalogue vide</div>`; return; }
  catalog.forEach((c,i)=>{
    const div = document.createElement('div');
    div.className="list-item";
    div.innerHTML = `
      <div class="name"><b>${c.name}</b> <span class="tag">${c.type}</span> ${c.img?'<span class="tag">üñºÔ∏è</span>':''} ${c.hint?`<span class="tag">${c.hint}</span>`:''} ${c.dist?`<span class="tag">${c.dist}km</span>`:''}
      </div>
      <button class="btn" onclick="addCatalogToProgram(${i})">‚ûï</button>`;
    box.appendChild(div);
  });
}
function renderProgramList(){
  const name = $('progName').value.trim();
  const p = programs[name] || tempProgram;
  const cont = $('programList'); cont.innerHTML="";
  if(!p || !p.exercises || !p.exercises.length){
    cont.innerHTML = `<div class="muted">Aucun exercice encore. Utilise le catalogue ‚ûï ou l‚Äôimport GitHub.</div>`;
    return;
  }
  p.exercises.forEach((ex,idx)=>{
    const row = document.createElement('div');
    row.className="list-item";
    row.innerHTML = `
      <div class="name"><b>${ex.name}</b> <span class="tag">${ex.type}</span> ${ex.img?'<span class="tag">üñºÔ∏è</span>':''}</div>
      <div class="row">
        <button class="btn" onclick="moveEx(${idx}, -1)">‚¨ÜÔ∏è</button>
        <button class="btn" onclick="moveEx(${idx}, 1)">‚¨áÔ∏è</button>
        <button class="btn danger" onclick="removeEx(${idx})">üóëÔ∏è</button>
      </div>`;
    cont.appendChild(row);
  });
}

/* ====== Programme temporaire (avant sauvegarde) ====== */
let tempProgram = { name:"", mode:"series", seriesPerEx:3, rounds:3, exercises:[] };

function syncBuilderHeaderToTemp(){
  tempProgram.name = $('progName').value.trim();
  tempProgram.mode = $('progMode').value;
  tempProgram.seriesPerEx = parseInt($('seriesCount').value||"3",10);
  tempProgram.rounds = parseInt($('rounds').value||"3",10);
}

/* ====== Builder Events ====== */
$('progMode').addEventListener('change', ()=>{
  const mode = $('progMode').value;
  $('seriesCountWrap').style.display = (mode==='series') ? 'block' : 'none';
  $('roundsWrap').style.display = (mode==='circuit') ? 'block' : 'none';
  syncBuilderHeaderToTemp();
});
$('seriesCount').addEventListener('input', syncBuilderHeaderToTemp);
$('rounds').addEventListener('input', syncBuilderHeaderToTemp);
$('progName').addEventListener('input', ()=>{ syncBuilderHeaderToTemp(); renderProgramList(); });

$('exoType').addEventListener('change', ()=>{
  const t = $('exoType').value;
  $('exoDefaultsStrength').style.display = (t==='strength')?'flex':'none';
  $('exoDefaultsRun').style.display = (t==='running')?'flex':'none';
});

// Aper√ßu image live
$('exoImg').addEventListener('input', ()=>{
  const url = $('exoImg').value.trim();
  const wrap = $('imgPreviewWrap');
  const img  = $('imgPreview');
  if(!url){ wrap.style.display = 'none'; img.src = ''; return; }
  img.onload = ()=> { wrap.style.display = 'block'; };
  img.onerror = ()=> { wrap.style.display = 'none'; img.src=''; };
  img.src = url;
});

$('addExoToCatalog').addEventListener('click', ()=>{
  const name = $('exoName').value.trim();
  const type = $('exoType').value;
  const img  = $('exoImg').value.trim();
  if(!name){ toast("Nom d‚Äôexercice requis"); return; }
  if(type==='strength'){
    catalog.push({ name, type, img, hint: $('exoHint').value.trim() });
  }else{
    const dist = parseFloat($('exoDist').value||"");
    const time = parseFloat($('exoTime').value||"");
    catalog.push({ name, type, img, dist:isNaN(dist)?undefined:dist, time:isNaN(time)?undefined:time });
  }
  save(CATALOG_KEY, catalog);
  $('exoName').value=''; $('exoImg').value=''; $('exoHint').value='';
  $('exoDist').value=''; $('exoTime').value='';
  $('imgPreviewWrap').style.display='none'; $('imgPreview').src='';
  renderCatalog(); toast("Exercice ajout√© au catalogue");
});

function addCatalogToProgram(i){
  const c = catalog[i];
  syncBuilderHeaderToTemp();
  if(!tempProgram.name){ toast("Donne un nom au programme d‚Äôabord"); return; }
  tempProgram.exercises.push({...c});
  renderProgramList();
}

function moveEx(idx, dir){
  const p = programs[tempProgram.name] || tempProgram;
  const arr = p.exercises;
  const j = idx+dir;
  if(j<0 || j>=arr.length) return;
  [arr[idx], arr[j]] = [arr[j], arr[idx]];
  renderProgramList();
}
function removeEx(idx){
  const p = programs[tempProgram.name] || tempProgram;
  p.exercises.splice(idx,1);
  renderProgramList();
}

$('saveProgramBtn').addEventListener('click', ()=>{
  syncBuilderHeaderToTemp();
  if(!tempProgram.name){ toast("Nom du programme manquant"); return; }
  if(!tempProgram.exercises.length){ toast("Ajoute au moins un exercice"); return; }
  programs[tempProgram.name] = JSON.parse(JSON.stringify(tempProgram));
  save(PROGS_KEY, programs);
  refreshProgramSelects();
  toast("Programme enregistr√© / mis √† jour");
});

$('loadProgramBtn').addEventListener('click', ()=>{
  const names = Object.keys(programs);
  if(!names.length){ toast("Aucun programme sauvegard√©"); return; }
  const ask = prompt("Nom exact du programme √† charger :", names[0]);
  if(!ask || !programs[ask]){ toast("Introuvable"); return; }
  tempProgram = JSON.parse(JSON.stringify(programs[ask]));
  $('progName').value = tempProgram.name;
  $('progMode').value = tempProgram.mode;
  $('seriesCount').value = tempProgram.seriesPerEx;
  $('rounds').value = tempProgram.rounds;
  $('seriesCountWrap').style.display = (tempProgram.mode==='series')?'block':'none';
  $('roundsWrap').style.display = (tempProgram.mode==='circuit')?'block':'none';
  renderProgramList();
  toast("Programme charg√© dans l‚Äô√©diteur");
});

$('clearProgramBtn').addEventListener('click', ()=>{
  tempProgram = { name:$('progName').value.trim()||"", mode:$('progMode').value, seriesPerEx:3, rounds:3, exercises:[] };
  renderProgramList();
});

/* ====== Import GitHub ====== */
$('ghScanBtn').addEventListener('click', syncFromGitHub);

async function syncFromGitHub(){
  const owner  = $('ghOwner').value.trim();
  const repo   = $('ghRepo').value.trim();
  const branch = $('ghBranch').value.trim() || 'main';
  const path   = $('ghPath').value.trim() || 'images';
  const defType= $('ghDefaultType').value;

  if(!owner || !repo){ toast("Owner et repo requis"); return; }

  const url = `https://api.github.com/repos/${encodeURIComponent(owner)}/${encodeURIComponent(repo)}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`;

  $('ghResult').textContent = "‚è≥ Scan en cours‚Ä¶";
  try{
    const res = await fetch(url, {headers:{'Accept':'application/vnd.github+json'}});
    if(!res.ok){ throw new Error(`HTTP ${res.status}`); }
    const list = await res.json();
    const imgs = list.filter(x=> x.type==='file' && /\.(png|jpe?g|webp|gif|svg)$/i.test(x.name));

    let created=0, updated=0;
    imgs.forEach(file=>{
      const imgPath = `${path}/${file.name}`;
      const guessedName = titleFromFilename(file.name);
      const existingIdx = catalog.findIndex(c=> c.name.toLowerCase() === guessedName.toLowerCase());

      if(existingIdx>=0){
        // Met √† jour l'image si vide ou diff√©rent
        if(!catalog[existingIdx].img || catalog[existingIdx].img !== imgPath){
          catalog[existingIdx].img = imgPath;
          updated++;
        }
      }else{
        // Cr√©e un nouvel exercice
        if(defType==='running'){
          catalog.push({ name: guessedName, type:'running', img: imgPath, dist:5, time:30 });
        }else{
          catalog.push({ name: guessedName, type:'strength', img: imgPath, hint:"" });
        }
        created++;
      }
    });

    save(CATALOG_KEY, catalog);
    renderCatalog();
    $('ghResult').textContent = `‚úÖ Termin√© : ${created} cr√©√©(s), ${updated} mis √† jour ‚Äî dans ‚Äú${path}/‚Äù sur ${branch}`;
    toast("Catalogue synchronis√© !");
  }catch(e){
    console.error(e);
    $('ghResult').textContent = `‚ùå Erreur: ${e.message}. V√©rifie owner/repo/branche/chemin et que le repo est public.`;
    toast("√âchec import GitHub");
  }
}

/* ====== Lancer une s√©ance ====== */
$('startSessionBtn').addEventListener('click', ()=>{
  const key = $('selectProgram').value;
  if(!key || !programs[key]){ toast("S√©lectionne un programme"); return; }
  renderSession(programs[key]);
  $('sessionCard').style.display = 'block';
  freeLines = [];
  renderFree();
});

/* ====== Rendu s√©ance ====== */
function renderSession(p){
  const zone = $('exercises'); zone.innerHTML = "";
  const mode = p.mode;
  const seriesPerEx = p.seriesPerEx || 3;
  const rounds = p.rounds || 3;

  const last = load(LAST_KEY) || {};
  function imgButton(exo){
    const url = exo.img||"";
    return url ? ` <button class="btn" onclick="showIllustration('${encodeURIComponent(url)}','${encodeURIComponent(exo.name)}')">üñºÔ∏è Illustration</button>` : "";
  }

  if(mode==='series'){
    p.exercises.forEach((exo,idx)=>{
      const hint = (exo.type==='strength' ? (exo.hint||"") : (exo.dist?`${exo.dist}km`:""));
      let html = `<div class="exercise-entry" id="exo-${idx}">
        <b>${exo.name}</b> ${imgButton(exo)} ${hint?`<span class="tag">${hint}</span>`:""}<br/>`;
      if(exo.type==='running'){
        for(let s=0;s<seriesPerEx;s++){
          const kd = `runD-${idx}-${s}`, kt = `runT-${idx}-${s}`;
          html += `<div class="series-row">
              S√©rie ${s+1} :
              Distance (km): <input type="number" id="${kd}" value="${last[kd]||""}" placeholder="${exo.dist||""}">
              Temps (min): <input type="number" id="${kt}" value="${last[kt]||""}" placeholder="${exo.time||""}">
            </div>`;
        }
      }else{
        for(let s=0;s<seriesPerEx;s++){
          const kp = `poids-${idx}-${s}`, kr = `rep-${idx}-${s}`;
          html += `<div class="series-row">
              S√©rie ${s+1} :
              Poids : <input type="text" id="${kp}" value="${last[kp]||""}" placeholder="${(exo.hint||'').split('/')[s]||''}">
              Reps : <input type="number" id="${kr}" value="${last[kr]||""}">
            </div>`;
        }
      }
      html += `<div class="row">
          <button class="btn good" onclick="markDone(${idx}, this)">‚úÖ Fait</button>
          <button class="btn" onclick="startTimer(this,30)">‚è±Ô∏è 30s</button>
          <button class="btn" onclick="startTimer(this,60)">‚è±Ô∏è 1min</button>
          <span class="timer" id="timer-${idx}"></span>
        </div>
      </div>`;
      zone.insertAdjacentHTML('beforeend', html);
    });
  } else {
    for(let r=0;r<rounds;r++){
      let block = `<div class="exercise-entry"><b>Tour ${r+1} / ${rounds}</b>`;
      p.exercises.forEach((exo,idx)=>{
        const hint = (exo.type==='strength' ? (exo.hint||"") : (exo.dist?`${exo.dist}km`:""));
        block += `<div class="series-row">
          <span class="pill"><b>${exo.name}</b> ${hint?`<span class="tag">${hint}</span>`:""} ${imgButton(exo)}</span>`;
        if(exo.type==='running'){
          const kd = `cD-${r}-${idx}`, kt = `cT-${r}-${idx}`;
          block += `Distance (km): <input type="number" id="${kd}" value="${last[kd]||""}" placeholder="${exo.dist||""}">
                    Temps (min): <input type="number" id="${kt}" value="${last[kt]||""}" placeholder="${exo.time||""}">`;
        }else{
          const kp = `cP-${r}-${idx}`, kr = `cR-${r}-${idx}`;
          block += `Poids: <input type="text" id="${kp}" value="${last[kp]||""}" placeholder="${(exo.hint||'').split('/')[0]||''}">
                    Reps: <input type="number" id="${kr}" value="${last[kr]||""}">`;
        }
        block += `</div>`;
      });
      block += `<div class="row" style="margin-top:6px">
        <button class="btn" onclick="startTimer(this,60)">‚è±Ô∏è 1min</button>
      </div></div>`;
      zone.insertAdjacentHTML('beforeend', block);
    }
  }
}

/* ====== Exercice libre ====== */
function addFreeLine(){
  freeLines.push({ name:"", type:"strength", poids:"", reps:"", dist:"", time:"" });
  renderFree();
}
function clearFree(){ freeLines=[]; renderFree(); }
function renderFree(){
  const box = $('freeList'); box.innerHTML="";
  if(!freeLines.length){ box.innerHTML = `<div class="muted">Aucun exercice libre ajout√©.</div>`; return; }
  freeLines.forEach((f, i)=>{
    const row = document.createElement('div');
    row.className="list-item";
    row.innerHTML = `
      <input style="flex:1" placeholder="Nom (ex: Squat jump)" value="${f.name}" oninput="freeLines[${i}].name=this.value"/>
      <select style="width:140px" onchange="freeLines[${i}].type=this.value">
        <option value="strength" ${f.type==='strength'?'selected':''}>Force</option>
        <option value="running" ${f.type==='running'?'selected':''}>Running</option>
      </select>
      <div class="row" style="gap:6px">
        <input placeholder="Poids" style="width:90px; display:${f.type==='strength'?'block':'none'}" value="${f.poids}" oninput="freeLines[${i}].poids=this.value"/>
        <input type="number" placeholder="Reps" style="width:90px; display:${f.type==='strength'?'block':'none'}" value="${f.reps}" oninput="freeLines[${i}].reps=this.value"/>
        <input type="number" step="0.1" placeholder="km" style="width:90px; display:${f.type==='running'?'block':'none'}" value="${f.dist}" oninput="freeLines[${i}].dist=this.value"/>
        <input type="number" placeholder="min" style="width:90px; display:${f.type==='running'?'block':'none'}" value="${f.time}" oninput="freeLines[${i}].time=this.value"/>
      </div>
      <button class="btn danger" onclick="freeLines.splice(${i},1); renderFree()">üóëÔ∏è</button>
    `;
    row.querySelector('select').addEventListener('change', ()=>renderFree());
    box.appendChild(row);
  });
}

/* ====== Actions s√©ance ====== */
function markDone(index, btn){ btn.textContent="‚úÖ Termin√©"; btn.disabled=true; }
function startTimer(btn, duration){
  const id = btn.closest('.exercise-entry').querySelector('.timer');
  let t = duration; btn.disabled=true; if(id) id.textContent=`${t}s restantes`;
  const itv = setInterval(()=>{ t--; if(id) id.textContent = t>=0?`${t}s restantes`:""; if(t<0){ clearInterval(itv); btn.disabled=false; } },1000);
}

function saveSession(){
  const progName = $('selectProgram').value;
  if(!progName || !programs[progName]){ toast("S√©lectionne un programme"); return; }
  const p = programs[progName];
  const mode = p.mode;
  const date = new Date().toLocaleString();

  let data = `üìÖ ${date} ‚Äì Programme : ${progName} (${mode})\n`;
  const toLast = {};

  if(mode==='series'){
    p.exercises.forEach((exo, idx)=>{
      data += `üî∏ ${exo.name} :\n`;
      if(exo.type==='running'){
        for(let s=0;s<p.seriesPerEx;s++){
          const kd = `runD-${idx}-${s}`, kt = `runT-${idx}-${s}`;
          const d = (document.getElementById(kd)||{}).value || "n.c.";
          const t = (document.getElementById(kt)||{}).value || "n.c.";
          toLast[kd]=d; toLast[kt]=t;
          data += `   ‚û§ S√©rie ${s+1} ‚Äì ${d} km en ${t} min\n`;
        }
      }else{
        for(let s=0;s<p.seriesPerEx;s++){
          const kp = `poids-${idx}-${s}`, kr = `rep-${idx}-${s}`;
          const P = (document.getElementById(kp)||{}).value || "n.c.";
          const R = (document.getElementById(kr)||{}).value || "n.c.";
          toLast[kp]=P; toLast[kr]=R;
          data += `   ‚û§ S√©rie ${s+1} ‚Äì ${R} reps @ ${P}\n`;
        }
      }
    });
  } else {
    for(let r=0;r<(p.rounds||3);r++){
      data += `‚Äî Tour ${r+1} ‚Äî\n`;
      p.exercises.forEach((exo, idx)=>{
        if(exo.type==='running'){
          const kd = `cD-${r}-${idx}`, kt = `cT-${r}-${idx}`;
          const d = (document.getElementById(kd)||{}).value || "n.c.";
          const t = (document.getElementById(kt)||{}).value || "n.c.";
          toLast[kd]=d; toLast[kt]=t;
          data += `   ${exo.name}: ${d} km en ${t} min\n`;
        }else{
          const kp = `cP-${r}-${idx}`, kr = `cR-${r}-${idx}`;
          const P = (document.getElementById(kp)||{}).value || "n.c.";
          const R = (document.getElementById(kr)||{}).value || "n.c.";
          toLast[kp]=P; toLast[kr]=R;
          data += `   ${exo.name}: ${R} reps @ ${P}\n`;
        }
      });
    }
  }

  // Exos libres
  if(freeLines.length){
    data += `‚ûï Exercices libres :\n`;
    freeLines.forEach(f=>{
      if(f.type==='running'){
        data += `   ${f.name}: ${f.dist||'n.c.'} km en ${f.time||'n.c.'} min\n`;
      }else{
        data += `   ${f.name}: ${f.reps||'n.c.'} reps @ ${f.poids||'n.c.'}\n`;
      }
    });
  }

  const old = (localStorage.getItem(HISTORY_KEY)||"");
  localStorage.setItem(HISTORY_KEY, data + "\n\n" + old);
  save(LAST_KEY, toLast);
  toast("üíæ S√©ance enregistr√©e !");
  freeLines=[]; renderFree();
  displayHistory();
}

/* ====== Historique ====== */
function displayHistory(){
  const h = (localStorage.getItem(HISTORY_KEY)||"").trim();
  const box = $('history'); box.innerHTML="";
  if(!h){ box.textContent="Aucune s√©ance encore."; return; }
  const sessions = h.split("\n\n");
  sessions.forEach((entry, idx)=>{
    const firstLine = entry.split("\n")[0] || "S√©ance";
    const div = document.createElement('div');
    div.className = "hist-item";
    div.innerHTML = `
      <pre>${entry}</pre>
      <div class="right">
        <button class="btn danger" onclick="deleteSession(${idx}, '${encodeURIComponent(firstLine)}')">üóëÔ∏è Supprimer</button>
      </div>`;
    box.appendChild(div);
  });
}
function deleteSession(index, summaryEnc){
  const summary = decodeURIComponent(summaryEnc);
  if(!confirm(`Supprimer d√©finitivement ?\n\n${summary}`)){ toast("Suppression annul√©e"); return; }
  let h = (localStorage.getItem(HISTORY_KEY)||"").trim();
  let sessions = h ? h.split("\n\n") : [];
  sessions.splice(index,1);
  localStorage.setItem(HISTORY_KEY, sessions.join("\n\n"));
  displayHistory();
  toast("S√©ance supprim√©e üóëÔ∏è");
}

/* ====== Modal image ====== */
function showIllustration(urlEnc, nameEnc){
  const url=decodeURIComponent(urlEnc), name=decodeURIComponent(nameEnc);
  $('imgView').src=url; $('imgTitle').textContent=name; $('imgModal').classList.add('open');
}
function hideModal(){ $('imgModal').classList.remove('open'); $('imgView').src=""; }
function closeModal(e){ if(e.target.id==='imgModal') hideModal(); }

/* ====== Stats page btn ====== */
$('openStats').addEventListener('click', ()=> window.open('graph.html','_blank') );

/* ====== Init ====== */
displayQuote();
refreshProgramSelects();
renderCatalog();
renderProgramList();

const first = Object.keys(programs)[0];
if(first){
  tempProgram = JSON.parse(JSON.stringify(programs[first]));
  $('progName').value = tempProgram.name;
  $('progMode').value = tempProgram.mode;
  $('seriesCount').value = tempProgram.seriesPerEx;
  $('rounds').value = tempProgram.rounds;
  $('seriesCountWrap').style.display = (tempProgram.mode==='series')?'block':'none';
  $('roundsWrap').style.display = (tempProgram.mode==='circuit')?'block':'none';
  renderProgramList();
}
displayHistory();
</script>
</body>
</html>
