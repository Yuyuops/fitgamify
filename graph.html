<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FitGamify – Statistiques</title>
<style>
  :root{
    --bg1:#0f1623; --bg2:#1b2433; --card:#121a28; --border:#273349;
    --txt:#e8efff; --muted:#9fb2d3; --glow1:#6a8bff; --glow2:#b26bff;
    --chip:#0f1725; --chipBorder:#243149; --btn:#3157ff;
  }
  *{box-sizing:border-box}
  body{
    margin:0; padding:18px; color:var(--txt);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    background:radial-gradient(1200px 600px at 10% -10%, #1f2a40 0%, transparent 60%),
               linear-gradient(135deg, var(--bg1), var(--bg2));
  }
  .wrap{max-width:1100px; margin:0 auto; display:grid; gap:16px}
  header{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
  h1{
    margin:0; font-size:1.6rem;
    background:linear-gradient(90deg,var(--glow1),var(--glow2));
    -webkit-background-clip:text; -webkit-text-fill-color:transparent;
  }
  .nav{display:flex; gap:8px; flex-wrap:wrap}
  .btn{
    background:#263247; color:#e8efff; border:1px solid #3a4a67;
    padding:.55rem .8rem; border-radius:10px; cursor:pointer; font-weight:600; text-decoration:none;
  }
  .btn.primary{ background:var(--btn); border-color:var(--btn) }
  .card{
    background:linear-gradient(180deg,#121a28,#0d1523);
    border:1px solid var(--border); border-radius:16px; padding:16px;
    box-shadow:0 10px 24px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.03);
  }
  h2{margin:.2rem 0 1rem; font-size:1.1rem}
  .grid{display:grid; gap:16px}
  @media(min-width:880px){ .grid{grid-template-columns:1fr 1fr} }
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .chip{
    background:var(--chip); border:1px solid var(--chipBorder);
    color:var(--txt); padding:.4rem .6rem; border-radius:999px; font-size:.95rem;
  }
  select{
    background:#0f1725; color:var(--txt); border:1px solid #334155;
    padding:10px 12px; border-radius:10px; outline:none;
  }
  .kpi{display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:10px}
  .kpi .box{
    background:#0f1725; border:1px solid #243149; border-radius:12px; padding:12px;
  }
  .kpi .label{color:var(--muted); font-size:.9rem}
  .kpi .value{font-size:1.3rem; font-weight:800}
  canvas{background:transparent !important}
  .muted{color:var(--muted)}
  .empty{color:var(--muted); font-style:italic}
  /* toast */
  #toast{position:fixed; left:50%; transform:translateX(-50%); bottom:16px;
         background:rgba(0,0,0,.85); color:#fff; padding:.6rem .9rem; border-radius:10px;
         opacity:0; pointer-events:none; transition:opacity .2s; z-index:9999}
  #toast.show{opacity:1}
</style>
</head>
<body>
<div class="wrap">

  <header>
    <h1>📈 FitGamify – Statistiques</h1>
    <div class="nav">
      <a class="btn" href="index.html">🏠 Accueil</a>
      <a class="btn" href="fitgamify.html">🏋️ Entraînement</a>
      <button class="btn primary" id="refreshBtn">🔄 Recharger données</button>
    </div>
  </header>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <span class="chip">Source : localStorage.fitHistory</span>
        <span class="chip" id="sessionCount">0 séance</span>
      </div>
      <div class="row">
        <label for="programFilter" class="muted">Programme</label>
        <select id="programFilter">
          <option value="all">Tous</option>
          <option value="Running">Running</option>
          <option value="Full Body">Full Body</option>
          <option value="Street Workout">Street Workout</option>
        </select>
        <label for="rangeFilter" class="muted">Période</label>
        <select id="rangeFilter">
          <option value="all">Tout</option>
          <option value="30">30 jours</option>
          <option value="90">90 jours</option>
        </select>
      </div>
    </div>

    <div class="kpi" style="margin-top:10px">
      <div class="box">
        <div class="label">Séances totales</div>
        <div class="value" id="kpiTotal">0</div>
      </div>
      <div class="box">
        <div class="label">Moyenne / semaine</div>
        <div class="value" id="kpiWeekAvg">–</div>
      </div>
      <div class="box">
        <div class="label">Programme le plus fréquent</div>
        <div class="value" id="kpiTopProg">–</div>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>📊 Répartition par programme</h2>
      <canvas id="mixChart" height="160"></canvas>
      <div class="muted" id="mixLegend" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h2>🏃 Running – Distance par séance</h2>
      <canvas id="runDistChart" height="160"></canvas>
      <div class="muted" id="runSummary" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h2>🏃 Running – Vitesse (min/km)</h2>
      <canvas id="runPaceChart" height="160"></canvas>
    </div>

    <div class="card">
      <h2>🏃 Running – Distance par semaine</h2>
      <canvas id="runWeekChart" height="160"></canvas>
    </div>

    <div class="card">
      <h2>🏋️ Volume (reps × kg) par séance</h2>
      <canvas id="volChart" height="180"></canvas>
      <div class="muted" id="volSummary" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h2>🗂️ Dernières séances (résumé)</h2>
      <div id="lastList" class="muted"></div>
    </div>
  </div>

</div>

<div id="toast"></div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
/* ========= Helpers ========= */
const $ = id => document.getElementById(id);
function toast(msg){ const t=$('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200); }
function parseDateFromHeader(line){
  // line ex: "📅 19/08/2025, 14:20:10 – Programme : Running"
  try{
    const raw = line.split('–')[0].replace('📅','').trim();
    const d = new Date(raw);
    if(!isNaN(d.getTime())) return d;
  }catch(e){}
  // fallback: now (keeps order roughly)
  return new Date();
}
function weekKey(d){ const dt=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate())); const day=dt.getUTCDay(); const diff=(day+6)%7; dt.setUTCDate(dt.getUTCDate()-diff); const y=dt.getUTCFullYear(); const m=String(dt.getUTCMonth()+1).padStart(2,'0'); const da=String(dt.getUTCDate()).padStart(2,'0'); return `${y}-${m}-${da}`;}
function avg(arr){ return arr.length? arr.reduce((a,b)=>a+b,0)/arr.length : 0; }
function round2(x){ return Math.round(x*100)/100; }

/* ========= Parse history ========= */
// History format from fitgamify.html
// Entry:
// 📅 <date> – Programme : <name>
// 🔸 <exo> :
//    ➤ Série X – <reps> reps @ <kg>kg
// or for running:
//    ➤ Séance X – <dist> km en <min> min
function getHistoryRaw(){
  const h = localStorage.getItem('fitHistory') || "";
  return h.trim();
}
function parseHistory(filterProg='all', rangeDays='all'){
  const raw = getHistoryRaw();
  if(!raw) return [];

  let entries = raw.split("\n\n").map(block=>{
    const lines = block.split("\n").map(s=>s.trim()).filter(Boolean);
    if(!lines.length) return null;
    const header = lines[0];
    const program = (header.split('Programme :')[1]||'').trim();
    const date = parseDateFromHeader(header);
    const dataLines = lines.slice(1);

    const rec = { header, program, date, running:[], lifts:[], volume:0, text:block };
    // parse lines
    const runRe = /Séance\s+\d+\s+–\s*([\d.,]+)\s*km\s*en\s*([\d.,]+)\s*min/i;
    const liftRe = /Série\s+\d+\s+–\s*([\d.,]+)\s*reps\s*@\s*([\d.,]+)\s*kg/i;

    dataLines.forEach(line=>{
      let m = runRe.exec(line);
      if(m){
        const dist = parseFloat(m[1].replace(',','.'));
        const min = parseFloat(m[2].replace(',','.'));
        if(!isNaN(dist) && !isNaN(min)){
          rec.running.push({dist, min});
        }
        return;
      }
      m = liftRe.exec(line);
      if(m){
        const reps = parseFloat(m[1].replace(',','.'));
        const kg   = parseFloat(m[2].replace(',','.'));
        if(!isNaN(reps) && !isNaN(kg)){
          rec.lifts.push({reps, kg});
          rec.volume += reps*kg;
        }
      }
    });
    return rec;
  }).filter(Boolean);

  // filter by program
  if(filterProg !== 'all'){
    entries = entries.filter(e => e.program === filterProg);
  }
  // filter by range
  if(rangeDays !== 'all'){
    const days = parseInt(rangeDays,10);
    const minTime = Date.now() - days*24*3600*1000;
    entries = entries.filter(e => e.date.getTime() >= minTime);
  }

  // sort by date asc
  entries.sort((a,b)=> a.date - b.date);
  return entries;
}

/* ========= Charts ========= */
let charts = {};
function destroyCharts(){
  Object.values(charts).forEach(ch=> ch && ch.destroy());
  charts = {};
}

function buildCharts(entries){
  destroyCharts();

  // Mix par programme
  const mix = {};
  entries.forEach(e => mix[e.program] = (mix[e.program]||0)+1);
  const mixL = Object.keys(mix);
  const mixV = mixL.map(k=>mix[k]);

  charts.mix = new Chart($('mixChart'), {
    type:'doughnut',
    data:{ labels:mixL, datasets:[{ data:mixV }] },
    options:{
      plugins:{
        legend:{ labels:{ color:'#cfe3ff' } }
      }
    }
  });
  $('mixLegend').textContent = mixL.length ? mixL.map((k,i)=>`${k}: ${mixV[i]}`).join(' • ') : "Pas de données";

  // Running charts
  const runEntries = entries.filter(e => e.program==='Running' && e.running.length);
  const runLabels = runEntries.map(e => e.date.toLocaleDateString());
  const runDistances = runEntries.map(e => e.running.reduce((s,r)=>s+r.dist,0));
  const runPaces = runEntries.map(e => {
    const dist = e.running.reduce((s,r)=>s+r.dist,0);
    const minutes = e.running.reduce((s,r)=>s+r.min,0);
    return dist>0 ? minutes/dist : NaN;
  });

  charts.runDist = new Chart($('runDistChart'), {
    type:'line',
    data:{ labels:runLabels, datasets:[{ label:'km', data:runDistances, tension:.25 }] },
    options:{ scales:{ x:{ ticks:{ color:'#9fb2d3' } }, y:{ ticks:{ color:'#9fb2d3' } } },
              plugins:{ legend:{ labels:{ color:'#cfe3ff' } } } }
  });

  charts.runPace = new Chart($('runPaceChart'), {
    type:'line',
    data:{ labels:runLabels, datasets:[{ label:'min/km', data:runPaces, tension:.25 }] },
    options:{ scales:{ x:{ ticks:{ color:'#9fb2d3' } }, y:{ ticks:{ color:'#9fb2d3' } } },
              plugins:{ legend:{ labels:{ color:'#cfe3ff' } } } }
  });

  // Running weekly distance
  const weekMap = {};
  runEntries.forEach(e=>{
    const wk = weekKey(e.date);
    weekMap[wk] = (weekMap[wk]||0) + e.running.reduce((s,r)=>s+r.dist,0);
  });
  const weekLabels = Object.keys(weekMap).sort();
  const weekVals = weekLabels.map(k=>weekMap[k]);

  charts.runWeek = new Chart($('runWeekChart'), {
    type:'bar',
    data:{ labels:weekLabels, datasets:[{ label:'km / semaine', data:weekVals }] },
    options:{ scales:{ x:{ ticks:{ color:'#9fb2d3' } }, y:{ ticks:{ color:'#9fb2d3' } } },
              plugins:{ legend:{ labels:{ color:'#cfe3ff' } } } }
  });

  // Strength volume per session (Full Body + Street Workout)
  const strEntries = entries.filter(e => e.volume>0);
  const volLabels = strEntries.map(e => `${e.program} ${e.date.toLocaleDateString()}`);
  const volValues = strEntries.map(e => round2(e.volume));
  charts.vol = new Chart($('volChart'), {
    type:'bar',
    data:{ labels:volLabels, datasets:[{ label:'Volume (reps×kg)', data:volValues }] },
    options:{ indexAxis:'y',
      scales:{ x:{ ticks:{ color:'#9fb2d3' } }, y:{ ticks:{ color:'#9fb2d3' } } },
      plugins:{ legend:{ labels:{ color:'#cfe3ff' } } }
    }
  });

  // Summaries
  const totalRuns = runEntries.length;
  const sumKm = runDistances.reduce((a,b)=>a+b,0);
  const avgKm = totalRuns ? round2(sumKm/totalRuns) : 0;
  const avgPace = runPaces.filter(x=>!isNaN(x)).length ? round2(avg(runPaces.filter(x=>!isNaN(x)))) : 0;
  $('runSummary').textContent = totalRuns ? `Séances running: ${totalRuns} • Total: ${round2(sumKm)} km • Moy: ${avgKm} km • Vitesse moy: ${avgPace} min/km` : "Aucune donnée running";

  const avgVol = strEntries.length ? round2(avg(volValues)) : 0;
  $('volSummary').textContent = strEntries.length ? `Séances force: ${strEntries.length} • Volume moyen: ${avgVol}` : "Aucune donnée force";
}

function rebuildKPIs(entries){
  $('kpiTotal').textContent = entries.length;
  // moyenne hebdo
  if(!entries.length){ $('kpiWeekAvg').textContent = '–'; $('kpiTopProg').textContent='–'; return; }
  const min = entries[0].date.getTime(), max = entries[entries.length-1].date.getTime();
  const weeks = Math.max(1, (max-min)/(7*24*3600*1000));
  $('kpiWeekAvg').textContent = (entries.length/weeks).toFixed(1);

  const freq = {};
  entries.forEach(e => freq[e.program]=(freq[e.program]||0)+1);
  const top = Object.entries(freq).sort((a,b)=>b[1]-a[1])[0];
  $('kpiTopProg').textContent = top ? `${top[0]} (${top[1]})` : '–';

  $('sessionCount').textContent = `${entries.length} ${entries.length>1?'séances':'séance'}`;
}

function rebuildLast(entries){
  const zone = $('lastList'); zone.innerHTML="";
  if(!entries.length){ zone.innerHTML = `<div class="empty">Aucune séance trouvée.</div>`; return; }
  const last = [...entries].slice(-8).reverse();
  last.forEach(e=>{
    const div = document.createElement('div');
    div.style.borderTop = '1px dashed #2b3952';
    div.style.padding = '8px 0';
    div.innerHTML = `<b>${e.program}</b> • ${e.date.toLocaleDateString()}<br><span class="muted">${e.header}</span>`;
    zone.appendChild(div);
  });
}

/* ========= Build all ========= */
function rebuildAll(){
  const prog = $('programFilter').value;
  const range = $('rangeFilter').value;
  const entries = parseHistory(prog, range);
  rebuildKPIs(entries);
  buildCharts(entries);
  rebuildLast(entries);
}

/* ========= Events ========= */
$('programFilter').addEventListener('change', rebuildAll);
$('rangeFilter').addEventListener('change', rebuildAll);
$('refreshBtn').addEventListener('click', ()=>{ toast('Rechargé'); rebuildAll(); });

/* ========= Init ========= */
rebuildAll();
</script>
</body>
</html>
